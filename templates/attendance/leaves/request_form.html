{% extends 'base.html' %}
{% load static %}

{% block title %}Solicitar Ausencia Laboral - EURO SECURITY{% endblock %}

{% block extra_css %}
<style>
    .section-header {
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        color: white;
        padding: 12px 20px;
        border-radius: 8px 8px 0 0;
        font-weight: 600;
        text-align: center;
        margin-top: 20px;
    }
    
    .form-section {
        background: #f8fafc;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .info-box {
        background: white;
        border-left: 4px solid #3b82f6;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 4px;
    }
    
    .permission-type-radio {
        display: inline-block;
        margin-right: 30px;
    }
    
    .permission-type-radio input[type="radio"] {
        margin-right: 8px;
    }
    
    .field-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    @media (max-width: 768px) {
        .field-row {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="h3 mb-2">
                    <i class="fas fa-file-signature text-primary me-2"></i>
                    EUROSECURITY CIA.LTDA.
                </h1>
                <div class="section-header">
                    SOLICITUD POR AUSENCIA LABORAL
                </div>
            </div>

            <!-- Formulario -->
            <form method="POST" enctype="multipart/form-data" id="leaveRequestForm">
                {% csrf_token %}
                
                <!-- DATOS DEL EMPLEADO SOLICITANTE -->
                <div class="section-header">
                    DATOS DEL EMPLEADO SOLICITANTE
                </div>
                <div class="form-section">
                    <div class="field-row">
                        <div>
                            <label class="form-label"><strong>NOMBRES Y APELLIDOS:</strong></label>
                            <input type="text" class="form-control" 
                                   value="{{ employee.get_full_name }}" readonly>
                        </div>
                        <div>
                            <label class="form-label"><strong>C√ìDIGO:</strong></label>
                            <input type="text" class="form-control" 
                                   value="{{ employee.employee_id }}" readonly>
                        </div>
                    </div>
                    
                    <div class="field-row">
                        <div>
                            <label class="form-label"><strong>PROYECTO:</strong></label>
                            <input type="text" class="form-control" name="project" 
                                   placeholder="Nombre del proyecto o cliente">
                        </div>
                        <div>
                            <label class="form-label"><strong>N¬∞ DE C√âDULA:</strong></label>
                            <input type="text" class="form-control" 
                                   value="{{ employee.national_id }}" readonly>
                        </div>
                    </div>
                    
                    <div class="field-row">
                        <div>
                            <label class="form-label"><strong>CARGO:</strong></label>
                            <input type="text" class="form-control" 
                                   value="{{ employee.position.title|default:'Sin cargo' }}" readonly>
                        </div>
                        <div>
                            <label class="form-label"><strong>√ÅREA:</strong></label>
                            <input type="text" class="form-control" 
                                   value="{{ employee.department.name|default:'Sin departamento' }}" readonly>
                        </div>
                    </div>
                    
                    <div>
                        <label class="form-label"><strong>NOMBRE DE JEFE INMEDIATO:</strong></label>
                        <input type="text" class="form-control" 
                               value="{{ employee.department.head.get_full_name|default:'Sin jefe asignado' }}" readonly>
                    </div>
                </div>

                <!-- DATOS DEL PERMISO SOLICITADO -->
                <div class="section-header">
                    DATOS DEL PERMISO SOLICITADO
                </div>
                <div class="form-section">
                    
                    <!-- Tipo de permiso -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Tipo de Permiso: *</strong></label>
                        <div class="permission-type-radio">
                            <input type="radio" name="permission_mode" value="DAYS" id="modeDays" checked>
                            <label for="modeDays">Permiso por d√≠as</label>
                        </div>
                        <div class="permission-type-radio">
                            <input type="radio" name="permission_mode" value="HOURS" id="modeHours">
                            <label for="modeHours">Permiso por horas</label>
                        </div>
                    </div>
                    
                    <!-- Permiso por d√≠as -->
                    <div id="daysModeSection">
                        <div class="field-row">
                            <div>
                                <label class="form-label"><strong>Desde: *</strong></label>
                                <input type="date" class="form-control" name="start_date" 
                                       id="startDate" required>
                            </div>
                            <div>
                                <label class="form-label"><strong>Hasta: *</strong></label>
                                <input type="date" class="form-control" name="end_date" 
                                       id="endDate" required>
                            </div>
                        </div>
                        <div>
                            <label class="form-label"><strong>Total d√≠as:</strong></label>
                            <input type="text" class="form-control" id="totalDays" 
                                   value="0 d√≠as" readonly>
                        </div>
                    </div>
                    
                    <!-- Permiso por horas -->
                    <div id="hoursModeSection" style="display: none;">
                        <div class="field-row">
                            <div>
                                <label class="form-label"><strong>Fecha: *</strong></label>
                                <input type="date" class="form-control" name="permission_date" 
                                       id="permissionDate">
                            </div>
                            <div></div>
                        </div>
                        <div class="field-row">
                            <div>
                                <label class="form-label"><strong>A partir de: *</strong></label>
                                <input type="time" class="form-control" name="start_time" 
                                       id="startTime" value="08:00">
                            </div>
                            <div>
                                <label class="form-label"><strong>Hasta las: *</strong></label>
                                <input type="time" class="form-control" name="end_time" 
                                       id="endTime" value="10:00">
                            </div>
                        </div>
                        <div>
                            <label class="form-label"><strong>Total horas:</strong></label>
                            <input type="text" class="form-control" id="totalHours" 
                                   value="2 horas" readonly>
                        </div>
                    </div>
                    
                    <!-- Motivo del permiso -->
                    <div class="mt-3">
                        <label class="form-label"><strong>Motivo del permiso: *</strong></label>
                        <select class="form-select" name="leave_type" id="leaveType" required>
                            <option value="">Seleccione un motivo...</option>
                            <optgroup label="üè• M√âDICAS (Usar Dr. Claude IA)">
                                <option value="medical_disability" data-medical="true">ü§ñ Incapacidad M√©dica</option>
                                <option value="medical_appointment" data-medical="true">ü§ñ Cita M√©dica</option>
                                <option value="medical_emergency" data-medical="true">ü§ñ Emergencia M√©dica</option>
                            </optgroup>
                            <optgroup label="üë®‚Äçüë©‚Äçüëß PERSONALES">
                                <option value="domestic_calamity">Calamidad Dom√©stica</option>
                                <option value="personal_matter">Asunto Personal</option>
                                <option value="personal_errand">Diligencia Personal</option>
                                <option value="marriage_permit">Permiso Matrimonio</option>
                                <option value="bereavement">Duelo Familiar</option>
                            </optgroup>
                            <optgroup label="üìö EDUCATIVAS">
                                <option value="study_permit">Permiso Estudio</option>
                                <option value="academic_exam">Examen Acad√©mico</option>
                                <option value="training">Capacitaci√≥n</option>
                            </optgroup>
                            <optgroup label="‚öñÔ∏è LEGALES">
                                <option value="court_summons">Citaci√≥n Judicial</option>
                                <option value="legal_procedure">Tr√°mite Legal</option>
                                <option value="mandatory_appearance">Comparecencia Obligatoria</option>
                            </optgroup>
                            <optgroup label="üéâ OTROS">
                                <option value="paid_leave">Permiso Remunerado</option>
                                <option value="compensatory_day">D√≠a Compensatorio</option>
                                <option value="special_license">Licencia Especial</option>
                                <option value="vacation">Vacaciones</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <!-- Descripci√≥n -->
                    <div class="mt-3">
                        <label class="form-label"><strong>Descripci√≥n detallada: *</strong></label>
                        <textarea class="form-control" name="reason_description" rows="3" 
                                  placeholder="Explique brevemente el motivo de su ausencia..." required></textarea>
                    </div>
                    
                    <!-- Soporte/Justificaci√≥n anexada -->
                    <div class="mt-3">
                        <label class="form-label"><strong>Soporte/Justificaci√≥n anexada:</strong></label>
                        <input type="file" class="form-control" name="supporting_document" 
                               accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                        <small class="text-muted">
                            Documento certificado por las entidades autorizadas. 
                            Formatos: PDF, Imagen, Word (m√°x. 10MB)
                        </small>
                    </div>
                </div>

                <!-- Informaci√≥n importante -->
                <div class="info-box">
                    <h6><i class="fas fa-info-circle text-primary me-2"></i>Informaci√≥n Importante:</h6>
                    <ul class="mb-0">
                        <li>Todos los campos marcados con (*) son obligatorios.</li>
                        <li>Para permisos m√©dicos, debe adjuntar el certificado correspondiente.</li>
                        <li>La solicitud ser√° revisada por su jefe inmediato y luego por RRHH.</li>
                        <li>Recibir√° notificaciones sobre el estado de su solicitud.</li>
                    </ul>
                </div>

                <!-- Botones -->
                <div class="d-flex justify-content-between mb-4">
                    <a href="{% url 'attendance:my_leave_requests' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-paper-plane me-2"></i>Enviar Solicitud
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>

<!-- Modal para redirigir a Dr. Claude -->
<div class="modal fade" id="medicalRedirectModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-robot me-2"></i>Permisos M√©dicos - Dr. Claude IA
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="fas fa-hospital-user fa-4x text-primary mb-3"></i>
                <h5>Para permisos m√©dicos, usa Dr. Claude IA</h5>
                <p class="text-muted">Dr. Claude IA analizar√° autom√°ticamente tu certificado m√©dico y crear√° la solicitud por ti.</p>
                
                <div class="alert alert-info text-start mt-3">
                    <strong><i class="fas fa-check-circle me-2"></i>Ventajas:</strong>
                    <ul class="mb-0">
                        <li>An√°lisis autom√°tico del certificado</li>
                        <li>Extracci√≥n de fechas y diagn√≥stico</li>
                        <li>Validaci√≥n de autenticidad</li>
                        <li>Aprobaci√≥n m√°s r√°pida</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <a href="{% url 'attendance:upload_medical_document' %}" class="btn btn-primary">
                    <i class="fas fa-robot me-2"></i>Ir a Dr. Claude
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Detectar si se selecciona tipo m√©dico
    const medicalRedirectModal = new bootstrap.Modal(document.getElementById('medicalRedirectModal'));
    
    document.getElementById('leaveType').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const isMedical = selectedOption.getAttribute('data-medical') === 'true';
        
        if (isMedical) {
            // Mostrar modal explicativo
            medicalRedirectModal.show();
            // Resetear selecci√≥n
            this.value = '';
        }
    });
    
    // Cambio entre d√≠as y horas
    document.querySelectorAll('input[name="permission_mode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const daysSection = document.getElementById('daysModeSection');
            const hoursSection = document.getElementById('hoursModeSection');
            
            if (this.value === 'DAYS') {
                daysSection.style.display = 'block';
                hoursSection.style.display = 'none';
                document.getElementById('startDate').required = true;
                document.getElementById('endDate').required = true;
                document.getElementById('permissionDate').required = false;
                document.getElementById('startTime').required = false;
                document.getElementById('endTime').required = false;
            } else {
                daysSection.style.display = 'none';
                hoursSection.style.display = 'block';
                document.getElementById('startDate').required = false;
                document.getElementById('endDate').required = false;
                document.getElementById('permissionDate').required = true;
                document.getElementById('startTime').required = true;
                document.getElementById('endTime').required = true;
            }
        });
    });
    
    // Calcular total de d√≠as
    function calculateDays() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById('totalDays').value = diffDays + ' d√≠as';
        }
    }
    
    document.getElementById('startDate').addEventListener('change', calculateDays);
    document.getElementById('endDate').addEventListener('change', calculateDays);
    
    // Calcular total de horas
    function calculateHours() {
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        
        if (startTime && endTime) {
            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);
            
            const startMinutes = startHour * 60 + startMin;
            const endMinutes = endHour * 60 + endMin;
            const diffMinutes = endMinutes - startMinutes;
            const hours = Math.floor(diffMinutes / 60);
            const minutes = diffMinutes % 60;
            
            document.getElementById('totalHours').value = hours + ' horas' + (minutes > 0 ? ' ' + minutes + ' min' : '');
        }
    }
    
    document.getElementById('startTime').addEventListener('change', calculateHours);
    document.getElementById('endTime').addEventListener('change', calculateHours);
    
    // Validaci√≥n del formulario
    document.getElementById('leaveRequestForm').addEventListener('submit', function(e) {
        const leaveType = document.getElementById('leaveType').value;
        if (!leaveType) {
            e.preventDefault();
            alert('Por favor seleccione el motivo del permiso.');
            return false;
        }
    });
</script>
{% endblock %}
