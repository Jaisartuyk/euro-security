{% extends 'base.html' %}
{% load static %}

{% block title %}Marcación Inteligente - EURO SECURITY{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Encabezado -->
            <div class="text-center mb-4">
                <h2 class="text-primary">
                    <i class="fas fa-fingerprint me-2"></i>
                    Sistema de Marcación Inteligente
                </h2>
                <p class="text-muted">
                    {% if has_facial_profile %}
                        Reconocimiento facial automático
                    {% else %}
                        Registro facial automático - Primera vez
                    {% endif %}
                </p>
            </div>

            <!-- Reloj Digital -->
            <div class="card mb-4">
                <div class="card-body text-center">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 id="current-time" class="mb-0 text-primary"></h4>
                        </div>
                        <div class="col-md-4">
                            <div class="action-icon mx-auto">
                                <i class="fas fa-clock fa-2x text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel Principal -->
            <div class="card">
                <div class="card-header {% if has_facial_profile %}has-profile{% else %}no-profile{% endif %}" id="main-header">
                    {% if has_facial_profile %}
                        <h5 class="mb-0 text-white">
                            <i class="fas fa-camera me-2"></i>
                            Reconocimiento Facial Automático
                        </h5>
                    {% else %}
                        <h5 class="mb-0 text-white">
                            <i class="fas fa-user-plus me-2"></i>
                            Registro Facial Automático - Primera Vez
                        </h5>
                    {% endif %}
                </div>
                <div class="card-body">
            <!-- Indicador de modo de emergencia -->
            <div class="alert alert-warning mb-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Modo de Emergencia Activo</strong> - El sistema aprobará automáticamente el reconocimiento
            </div>
        
                    <!-- Estado del Sistema -->
                    <div class="alert alert-info" id="system-status">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-3" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <div>
                                <strong>Iniciando sistema...</strong>
                                <div class="small">
                                    {% if has_facial_profile %}
                                        Preparando reconocimiento facial
                                    {% else %}
                                        Preparando registro facial automático
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Instrucciones para primera vez -->
                    {% if not has_facial_profile %}
                    <div class="alert alert-warning" id="first-time-instructions">
                        <h6><i class="fas fa-info-circle me-2"></i>Primera Vez - Registro Automático</h6>
                        <p class="mb-2">El sistema capturará automáticamente 3-5 fotos de tu rostro para crear tu perfil:</p>
                        <ul class="mb-0">
                            <li>Mantén tu rostro centrado en la cámara</li>
                            <li>Mira directamente a la cámara</li>
                            <li>Mantén buena iluminación</li>
                            <li>El proceso es completamente automático</li>
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Video Feed -->
                    <div class="text-center mb-4">
                        <div class="video-container position-relative">
                            <video id="video" width="640" height="480" autoplay muted playsinline></video>
                            <canvas id="canvas" width="640" height="480" style="display: none;"></canvas>
                            
                            <!-- Overlay de detección -->
                            <div id="face-overlay" class="position-absolute top-0 start-0 w-100 h-100" style="pointer-events: none;">
                                <!-- Aquí se dibujarán los rectángulos de detección -->
                            </div>
                            
                            <!-- Indicador de estado -->
                            <div id="detection-indicator" class="position-absolute top-0 end-0 m-3">
                                <div class="badge bg-secondary">
                                    <i class="fas fa-search me-1"></i>
                                    Iniciando...
                                </div>
                            </div>

                            <!-- Contador de fotos (solo primera vez) -->
                            {% if not has_facial_profile %}
                            <div id="photo-counter" class="position-absolute bottom-0 start-0 m-3" style="display: none;">
                                <div class="badge bg-success fs-6">
                                    <i class="fas fa-camera me-1"></i>
                                    Fotos: <span id="photo-count">0</span>/5
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Información de ubicación -->
                    <div class="alert alert-warning" id="location-info" style="display: none;">
                        <h6><i class="fas fa-map-marker-alt me-2"></i>Ubicación</h6>
                        <div id="location-details">
                            <small>Obteniendo ubicación...</small>
                        </div>
                    </div>

                    <!-- Progreso de proceso -->
                    <div id="process-progress" class="mb-3" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small" id="process-text">Procesando...</span>
                            <span class="small" id="progress-text">0%</span>
                        </div>
                        <div class="progress">
                            <div id="progress-bar" class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Resultado -->
                    <div id="result-container" style="display: none;">
                        <!-- Aquí se mostrará el resultado -->
                    </div>
                </div>
            </div>

            <!-- Registros del día -->
            <div class="card mt-4">
                <div class="card-header">
                    <i class="fas fa-list me-2"></i>
                    Mis Registros de Hoy
                </div>
                <div class="card-body">
            <!-- Indicador de modo de emergencia -->
            <div class="alert alert-warning mb-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Modo de Emergencia Activo</strong> - El sistema aprobará automáticamente el reconocimiento
            </div>
        
                    {% if today_records %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Hora</th>
                                        <th>Tipo</th>
                                        <th>Ubicación</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in today_records %}
                                    <tr>
                                        <td>{{ record.timestamp|time:"H:i" }}</td>
                                        <td>
                                            <span class="badge bg-{% if record.attendance_type == 'IN' %}success{% else %}warning{% endif %}">
                                                {% if record.attendance_type == 'IN' %}Entrada{% else %}Salida{% endif %}
                                            </span>
                                        </td>
                                        <td>{{ record.location_name|default:"No especificada" }}</td>
                                        <td>
                                            {% if record.is_valid %}
                                                <i class="fas fa-check-circle text-success"></i>
                                            {% else %}
                                                <i class="fas fa-clock text-warning"></i>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-calendar-times fa-3x mb-3"></i>
                            <p>No hay registros para hoy</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .video-container {
        position: relative;
        display: inline-block;
        border: 3px solid #007bff;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        background: #000;
        width: 100%;
        max-width: 640px;
        margin: 0 auto;
    }
    
    #video {
        display: block;
        width: 100%;
        height: auto;
        object-fit: cover;
    }
    
    .action-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(0,123,255,0.1);
    }
    
    .face-box {
        position: absolute;
        border: 3px solid #28a745;
        border-radius: 8px;
        background: rgba(40, 167, 69, 0.1);
        transition: all 0.3s ease;
    }
    
    .face-box.capturing {
        border-color: #ffc107;
        background: rgba(255, 193, 7, 0.2);
        animation: captureFlash 0.5s ease-in-out;
    }
    
    .face-box.recognized {
        border-color: #007bff;
        background: rgba(0, 123, 255, 0.1);
        box-shadow: 0 0 20px rgba(0, 123, 255, 0.5);
    }
    
    @keyframes captureFlash {
        0% { background: rgba(255, 193, 7, 0.2); }
        50% { background: rgba(255, 193, 7, 0.6); }
        100% { background: rgba(255, 193, 7, 0.2); }
    }
    
    .detection-pulse {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .success-animation {
        animation: successPulse 1s ease-in-out;
    }
    
    @keyframes successPulse {
        0% { transform: scale(1); background-color: rgba(40, 167, 69, 0.1); }
        50% { transform: scale(1.1); background-color: rgba(40, 167, 69, 0.3); }
        100% { transform: scale(1); background-color: rgba(40, 167, 69, 0.1); }
    }

    /* Estilos para primera vez */
    .card-header.has-profile {
        background: #007bff !important;
    }
    
    .card-header.no-profile {
        background: #28a745 !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Configuración desde Django -->
<script id="django-config" type="application/json">
{
    "hasProfile": {% if has_facial_profile %}true{% else %}false{% endif %},
    "csrfToken": "{{ csrf_token }}",
    "recordUrl": "{% url 'attendance:record' %}",
    "createProfileUrl": "{% url 'attendance:create_profile' %}"
}
</script>

<script>
    // Configuración desde Django
    const djangoConfig = JSON.parse(document.getElementById('django-config').textContent);
    
    // Variables globales
    let video = null;
    let canvas = null;
    let context = null;
    let stream = null;
    let currentLocation = null;
    let detectionInterval = null;
    let isProcessing = false;
    let lastDetectionTime = 0;
    
    // Variables para registro automático
    const hasProfile = djangoConfig.hasProfile;
    let capturedPhotos = [];
    let photoCount = 0;
    const maxPhotos = 5;
    let isCapturingPhotos = false;
    
    // Configuración
    const DETECTION_INTERVAL = hasProfile ? 1000 : 2000; // Más lento para primera vez
    const CONFIDENCE_THRESHOLD = 0.50;
    const PROCESSING_COOLDOWN = hasProfile ? 5000 : 2000;
    
    document.addEventListener('DOMContentLoaded', function() {
        video = document.getElementById('video');
        canvas = document.getElementById('canvas');
        context = canvas.getContext('2d');
        
        // Inicializar sistema
        initializeSystem();
    });
    
    async function initializeSystem() {
        updateClock();
        setInterval(updateClock, 1000);
        
        updateStatus('Obteniendo ubicación...', 'info');
        await getCurrentLocation();
        
        updateStatus('Iniciando cámara...', 'info');
        await startCamera();
        
        if (hasProfile) {
            updateStatus('Sistema listo - Reconocimiento automático activo', 'success');
        } else {
            updateStatus('Sistema listo - Registro automático iniciado', 'success');
            showPhotoCounter(true);
        }
        
        startFaceDetection();
    }
    
    function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('es-ES');
        const dateString = now.toLocaleDateString('es-ES', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        document.getElementById('current-time').textContent = `${dateString} - ${timeString}`;
    }
    
    function getCurrentLocation() {
        return new Promise((resolve) => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        
                        document.getElementById('location-info').style.display = 'block';
                        document.getElementById('location-details').innerHTML = `
                            <div><strong>Latitud:</strong> ${currentLocation.latitude.toFixed(6)}</div>
                            <div><strong>Longitud:</strong> ${currentLocation.longitude.toFixed(6)}</div>
                            <div><strong>Precisión:</strong> ±${Math.round(currentLocation.accuracy)} metros</div>
                        `;
                        resolve();
                    },
                    function(error) {
                        console.error('Error obteniendo ubicación:', error);
                        document.getElementById('location-info').style.display = 'block';
                        document.getElementById('location-details').innerHTML = `
                            <div class="text-danger">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                Error obteniendo ubicación: ${error.message}
                            </div>
                        `;
                        resolve();
                    }
                );
            } else {
                resolve();
            }
        });
    }
    
    async function startCamera() {
        try {
            // Configuración más flexible de la cámara
            const constraints = {
                video: {
                    width: { ideal: 640, max: 1280 },
                    height: { ideal: 480, max: 720 },
                    facingMode: 'user',
                    aspectRatio: 4/3
                }
            };
            
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            
            return new Promise((resolve) => {
                video.onloadedmetadata = () => {
                    video.play();
                    console.log('Cámara iniciada:', video.videoWidth + 'x' + video.videoHeight);
                    resolve();
                };
            });
        } catch (error) {
            console.error('Error accediendo a la cámara:', error);
            updateStatus('Error: No se pudo acceder a la cámara. Verifique permisos.', 'danger');
            throw error;
        }
    }
    
    function startFaceDetection() {
        if (hasProfile) {
            updateDetectionIndicator('Reconocimiento activo', 'success');
        } else {
            updateDetectionIndicator('Registro automático activo', 'warning');
        }
        
        detectionInterval = setInterval(() => {
            if (!isProcessing && video.readyState === 4) {
                if (hasProfile) {
                    detectAndRecognizeFace();
                } else {
                    detectAndCaptureFace();
                }
            }
        }, DETECTION_INTERVAL);
    }
    
    async function detectAndCaptureFace() {
        if (photoCount >= maxPhotos) {
            // Ya tenemos suficientes fotos, procesar perfil
            await processCollectedPhotos();
            return;
        }
        
        try {
            // Capturar frame actual
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Simular detección de rostro
            const faceDetected = Math.random() > 0.2; // 80% probabilidad
            
            if (faceDetected && !isCapturingPhotos) {
                updateDetectionIndicator('Rostro detectado - Capturando...', 'warning');
                showFaceBox(100, 100, 200, 200, 'capturing');
                
                // Capturar foto automáticamente
                await capturePhotoForProfile(imageData);
            } else if (!faceDetected) {
                updateDetectionIndicator('Buscando rostro...', 'secondary');
                clearFaceBoxes();
            }
            
        } catch (error) {
            console.error('Error en detección:', error);
        }
    }
    
    async function capturePhotoForProfile(imageData) {
        if (isCapturingPhotos) return;
        
        isCapturingPhotos = true;
        photoCount++;
        
        // Comprimir foto antes de agregar a la colección
        const compressedPhoto = await compressImage(imageData, 0.8, 480, 360);
        capturedPhotos.push(compressedPhoto);
        
        // Actualizar contador
        updatePhotoCounter(photoCount);
        
        // Mostrar feedback visual
        showFaceBox(100, 100, 200, 200, 'capturing');
        
        updateDetectionIndicator(`Foto ${photoCount}/${maxPhotos} capturada`, 'success');
        
        // Pausa breve antes de la siguiente captura
        setTimeout(() => {
            isCapturingPhotos = false;
            clearFaceBoxes();
            
            if (photoCount >= maxPhotos) {
                updateDetectionIndicator('Procesando perfil...', 'primary');
            } else {
                updateDetectionIndicator('Registro automático activo', 'warning');
            }
        }, 1500);
    }
    
    async function processCollectedPhotos() {
        if (capturedPhotos.length === 0) return;
        
        clearInterval(detectionInterval);
        updateDetectionIndicator('Creando perfil facial...', 'primary');
        showProgress(true, 'Procesando fotos capturadas...');
        
        try {
            // Simular progreso
            for (let i = 0; i <= 100; i += 10) {
                updateProgress(i, `Procesando foto ${Math.ceil(i/20)}/${capturedPhotos.length}...`);
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            // Enviar fotos para crear perfil
            const response = await fetch(djangoConfig.createProfileUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': djangoConfig.csrfToken
                },
                body: JSON.stringify({
                    photos: capturedPhotos,
                    location: currentLocation
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showSuccessResult({
                    message: '¡Perfil facial creado exitosamente!',
                    details: `Se procesaron ${capturedPhotos.length} fotos`,
                    next_step: 'Ahora puedes marcar asistencia normalmente'
                });
                
                // Cambiar a modo reconocimiento
                setTimeout(() => {
                    location.reload(); // Recargar para cambiar a modo reconocimiento
                }, 3000);
            } else {
                showErrorResult(result.error || 'Error creando perfil facial');
            }
            
        } catch (error) {
            console.error('Error procesando fotos:', error);
            showErrorResult('Error de conexión al procesar fotos');
        } finally {
            showProgress(false);
        }
    }
    
    async function detectAndRecognizeFace() {
        try {
            // Capturar frame actual
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Simular detección de rostro
            const faceDetected = Math.random() > 0.3; // 70% probabilidad
            
            if (faceDetected) {
                updateDetectionIndicator('Rostro detectado', 'warning');
                showFaceBox(100, 100, 200, 200);
                
                // Procesar reconocimiento
                await processRecognition(imageData);
            } else {
                updateDetectionIndicator('Buscando rostro...', 'secondary');
                clearFaceBoxes();
            }
            
        } catch (error) {
            console.error('Error en detección:', error);
        }
    }
    
    // Función para comprimir imagen
    function compressImage(imageData, quality = 0.7, maxWidth = 640, maxHeight = 480) {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Calcular nuevas dimensiones manteniendo aspecto
                let { width, height } = img;
                
                if (width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    width *= ratio;
                    height *= ratio;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Dibujar imagen redimensionada
                ctx.drawImage(img, 0, 0, width, height);
                
                // Comprimir y devolver
                const compressedData = canvas.toDataURL('image/jpeg', quality);
                console.log('Imagen comprimida:', {
                    original: imageData.length,
                    compressed: compressedData.length,
                    reduction: Math.round((1 - compressedData.length / imageData.length) * 100) + '%'
                });
                resolve(compressedData);
            };
            
            img.src = imageData;
        });
    }

    async function processRecognition(imageData) {
        if (isProcessing || (Date.now() - lastDetectionTime) < PROCESSING_COOLDOWN) {
            return;
        }
        
        isProcessing = true;
        lastDetectionTime = Date.now();
        
        updateDetectionIndicator('Reconociendo...', 'primary');
        showProgress(true, 'Comprimiendo imagen...');
        
        try {
            // Comprimir imagen antes del envío
            const compressedImage = await compressImage(imageData, 0.8, 640, 480);
            
            // Simular progreso de reconocimiento
            for (let i = 0; i <= 100; i += 10) {
                updateProgress(i, `Analizando... ${i}%`);
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Enviar para reconocimiento
            console.log('Enviando imagen para reconocimiento...', {
                url: djangoConfig.recordUrl,
                imageSize: compressedImage.length,
                location: currentLocation
            });
            
            const response = await fetch(djangoConfig.recordUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': djangoConfig.csrfToken
                },
                body: JSON.stringify({
                    attendance_type: '{{ next_action }}',
                    facial_image: compressedImage,
                    latitude: currentLocation?.latitude,
                    longitude: currentLocation?.longitude,
                    location_accuracy: currentLocation?.accuracy,
                    device_info: navigator.userAgent
                })
            });
            
            console.log('Respuesta recibida:', response.status, response.statusText);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log('Resultado del reconocimiento:', result);
            
            if (result.success) {
                showSuccessResult(result);
                updateDetectionIndicator('¡Reconocido!', 'success');
                showFaceBoxRecognized();
                
                // Pausa la detección por un momento
                setTimeout(() => {
                    clearFaceBoxes();
                    updateDetectionIndicator('Reconocimiento activo', 'success');
                }, 3000);
            } else {
                showErrorResult(result.error);
                updateDetectionIndicator('No reconocido', 'danger');
            }
            
        } catch (error) {
            console.error('Error en reconocimiento:', error);
            showErrorResult('Error de conexión');
            updateDetectionIndicator('Error', 'danger');
        } finally {
            showProgress(false);
            isProcessing = false;
        }
    }
    
    // Funciones de UI
    function updateStatus(message, type) {
        const statusDiv = document.getElementById('system-status');
        statusDiv.className = `alert alert-${type}`;
        statusDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-3"></i>
                <div>
                    <strong>${message}</strong>
                </div>
            </div>
        `;
    }
    
    function updateDetectionIndicator(text, type) {
        const indicator = document.getElementById('detection-indicator');
        indicator.innerHTML = `
            <div class="badge bg-${type}">
                <i class="fas fa-${type === 'success' ? 'check' : type === 'warning' ? 'camera' : type === 'primary' ? 'cog fa-spin' : 'search'} me-1"></i>
                ${text}
            </div>
        `;
    }
    
    function showPhotoCounter(show) {
        const counter = document.getElementById('photo-counter');
        if (counter) {
            counter.style.display = show ? 'block' : 'none';
        }
    }
    
    function updatePhotoCounter(count) {
        const countSpan = document.getElementById('photo-count');
        if (countSpan) {
            countSpan.textContent = count;
        }
    }
    
    function showFaceBox(x, y, width, height, className = '') {
        clearFaceBoxes();
        const overlay = document.getElementById('face-overlay');
        const faceBox = document.createElement('div');
        faceBox.className = `face-box detection-pulse ${className}`;
        faceBox.style.left = `${x}px`;
        faceBox.style.top = `${y}px`;
        faceBox.style.width = `${width}px`;
        faceBox.style.height = `${height}px`;
        overlay.appendChild(faceBox);
    }
    
    function showFaceBoxRecognized() {
        const faceBox = document.querySelector('.face-box');
        if (faceBox) {
            faceBox.classList.add('recognized', 'success-animation');
        }
    }
    
    function clearFaceBoxes() {
        const overlay = document.getElementById('face-overlay');
        overlay.innerHTML = '';
    }
    
    function showProgress(show, text = '') {
        const progressDiv = document.getElementById('process-progress');
        progressDiv.style.display = show ? 'block' : 'none';
        if (text) {
            document.getElementById('process-text').textContent = text;
        }
        if (!show) {
            updateProgress(0);
        }
    }
    
    function updateProgress(percentage, text = '') {
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        progressBar.style.width = `${percentage}%`;
        progressText.textContent = `${percentage}%`;
        if (text) {
            document.getElementById('process-text').textContent = text;
        }
    }
    
    function showSuccessResult(result) {
        const container = document.getElementById('result-container');
        container.style.display = 'block';
        
        if (result.message) {
            // Resultado de creación de perfil
            container.innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>${result.message}</h5>
                    <p><strong>Detalles:</strong> ${result.details}</p>
                    <p class="mb-0"><strong>Siguiente paso:</strong> ${result.next_step}</p>
                </div>
            `;
        } else {
            // Resultado de marcación
            container.innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>¡Asistencia Marcada!</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Tipo:</strong> ${result.attendance_type === 'IN' ? 'Entrada' : 'Salida'}<br>
                            <strong>Hora:</strong> ${new Date().toLocaleTimeString('es-ES')}<br>
                            <strong>Confianza:</strong> ${result.confidence || '85'}%
                        </div>
                        <div class="col-md-6">
                            <strong>Ubicación:</strong> ${result.location || 'Oficina Principal'}<br>
                            <strong>Estado:</strong> <span class="badge bg-success">Aprobado</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Ocultar después de 5 segundos
        setTimeout(() => {
            container.style.display = 'none';
        }, 5000);
    }
    
    function showErrorResult(error) {
        const container = document.getElementById('result-container');
        container.style.display = 'block';
        container.innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Error en el Proceso</h5>
                <p class="mb-0">${error}</p>
            </div>
        `;
        
        // Ocultar después de 5 segundos
        setTimeout(() => {
            container.style.display = 'none';
        }, 5000);
    }
    
    // Limpiar al salir
    window.addEventListener('beforeunload', function() {
        if (detectionInterval) {
            clearInterval(detectionInterval);
        }
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
    });
</script>
{% endblock %}
