{% extends 'base.html' %}

{% block title %}Marcación de Asistencia - {{ employee.get_full_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="h3 mb-2">
                    <i class="fas fa-clock text-primary me-2"></i>
                    Control de Asistencia
                </h1>
                <p class="text-muted">{{ employee.get_full_name }} - {{ employee.position.title }}</p>
                <div class="badge bg-success fs-6" id="current-time"></div>
            </div>

            <!-- Cámara y Marcación -->
            <div class="card mb-4">
                <div class="card-header text-center">
                    <i class="fas fa-camera me-2"></i>
                    Reconocimiento Facial para {{ next_action|title }}
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <!-- Vista de la cámara -->
                            <div class="camera-container text-center mb-3">
                                <video id="video" width="300" height="225" autoplay muted class="border rounded"></video>
                                <canvas id="canvas" width="300" height="225" style="display: none;"></canvas>
                            </div>
                            
                            <div class="text-center">
                                <button id="start-camera" class="btn btn-info me-2">
                                    <i class="fas fa-video me-1"></i>
                                    Iniciar Cámara
                                </button>
                                <button id="capture-photo" class="btn btn-primary me-2" disabled>
                                    <i class="fas fa-camera me-1"></i>
                                    Capturar
                                </button>
                                <button id="stop-camera" class="btn btn-secondary" disabled>
                                    <i class="fas fa-stop me-1"></i>
                                    Detener
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <!-- Información de marcación -->
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>Próxima Acción</h6>
                                <div class="d-flex align-items-center">
                                    <div class="action-icon me-3">
                                        {% if next_action == 'IN' %}
                                            <i class="fas fa-sign-in-alt fa-2x text-success"></i>
                                        {% elif next_action == 'OUT' %}
                                            <i class="fas fa-sign-out-alt fa-2x text-danger"></i>
                                        {% elif next_action == 'BREAK_OUT' %}
                                            <i class="fas fa-coffee fa-2x text-warning"></i>
                                        {% elif next_action == 'BREAK_IN' %}
                                            <i class="fas fa-undo fa-2x text-info"></i>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <strong>
                                            {% if next_action == 'IN' %}
                                                Marcar Entrada
                                            {% elif next_action == 'OUT' %}
                                                Marcar Salida
                                            {% elif next_action == 'BREAK_OUT' %}
                                                Salir a Descanso
                                            {% elif next_action == 'BREAK_IN' %}
                                                Regresar de Descanso
                                            {% endif %}
                                        </strong>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Información de ubicación -->
                            <div class="alert alert-warning" id="location-info" style="display: none;">
                                <h6><i class="fas fa-map-marker-alt me-2"></i>Ubicación</h6>
                                <div id="location-details">
                                    <small>Obteniendo ubicación...</small>
                                </div>
                            </div>
                            
                            <!-- Botón de marcación -->
                            <div class="d-grid">
                                <button id="mark-attendance" class="btn btn-success btn-lg" disabled>
                                    <i class="fas fa-fingerprint me-2"></i>
                                    <span id="mark-button-text">Marcar {{ next_action|title }}</span>
                                </button>
                            </div>
                            
                            <!-- Estado del proceso -->
                            <div id="process-status" class="mt-3" style="display: none;">
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted mt-1 d-block" id="status-text">Iniciando proceso...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registros del día -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-list me-2"></i>
                    Mis Registros de Hoy
                </div>
                <div class="card-body">
                    {% if today_records %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Hora</th>
                                        <th>Tipo</th>
                                        <th>Método</th>
                                        <th>Ubicación</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in today_records %}
                                    <tr>
                                        <td>{{ record.timestamp|time:"H:i:s" }}</td>
                                        <td>
                                            <span class="badge bg-{% if record.attendance_type == 'IN' %}success{% elif record.attendance_type == 'OUT' %}danger{% else %}warning{% endif %}">
                                                {{ record.get_attendance_type_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <i class="fas fa-{% if record.verification_method == 'FACIAL' %}user-check{% else %}user{% endif %} me-1"></i>
                                            {{ record.get_verification_method_display }}
                                        </td>
                                        <td>
                                            {% if record.latitude and record.longitude %}
                                                <small class="text-muted">{{ record.latitude|floatformat:4 }}, {{ record.longitude|floatformat:4 }}</small>
                                            {% else %}
                                                <small class="text-muted">Sin ubicación</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if record.is_valid %}
                                                <span class="badge bg-success">Válido</span>
                                            {% else %}
                                                <span class="badge bg-warning">Pendiente</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-clock fa-3x mb-3"></i>
                            <p>No hay registros para hoy</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de resultado -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resultado de Marcación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="result-content">
                <!-- Contenido dinámico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendido</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .camera-container {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
    }
    
    #video {
        border: 3px solid #007bff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .action-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(0,123,255,0.1);
    }
    
    #mark-attendance:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .progress {
        height: 8px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Variables globales
    let video = null;
    let canvas = null;
    let context = null;
    let stream = null;
    let currentLocation = null;
    let capturedImage = null;
    
    // Elementos del DOM
    const startCameraBtn = document.getElementById('start-camera');
    const capturePhotoBtn = document.getElementById('capture-photo');
    const stopCameraBtn = document.getElementById('stop-camera');
    const markAttendanceBtn = document.getElementById('mark-attendance');
    const processStatus = document.getElementById('process-status');
    const statusText = document.getElementById('status-text');
    const progressBar = document.querySelector('.progress-bar');
    
    document.addEventListener('DOMContentLoaded', function() {
        video = document.getElementById('video');
        canvas = document.getElementById('canvas');
        context = canvas.getContext('2d');
        
        // Actualizar reloj
        updateClock();
        setInterval(updateClock, 1000);
        
        // Obtener ubicación al cargar
        getCurrentLocation();
        
        // Event listeners
        startCameraBtn.addEventListener('click', startCamera);
        capturePhotoBtn.addEventListener('click', capturePhoto);
        stopCameraBtn.addEventListener('click', stopCamera);
        markAttendanceBtn.addEventListener('click', markAttendance);
    });
    
    function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('es-ES');
        const dateString = now.toLocaleDateString('es-ES', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        document.getElementById('current-time').textContent = `${dateString} - ${timeString}`;
    }
    
    function getCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    document.getElementById('location-info').style.display = 'block';
                    document.getElementById('location-details').innerHTML = `
                        <div><strong>Latitud:</strong> ${currentLocation.latitude.toFixed(6)}</div>
                        <div><strong>Longitud:</strong> ${currentLocation.longitude.toFixed(6)}</div>
                        <div><strong>Precisión:</strong> ±${Math.round(currentLocation.accuracy)} metros</div>
                    `;
                },
                function(error) {
                    console.error('Error obteniendo ubicación:', error);
                    document.getElementById('location-info').style.display = 'block';
                    document.getElementById('location-details').innerHTML = `
                        <div class="text-danger">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            No se pudo obtener la ubicación
                        </div>
                    `;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        } else {
            alert('Geolocalización no soportada por este navegador');
        }
    }
    
    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: 300, 
                    height: 225,
                    facingMode: 'user'
                } 
            });
            video.srcObject = stream;
            
            startCameraBtn.disabled = true;
            capturePhotoBtn.disabled = false;
            stopCameraBtn.disabled = false;
            
        } catch (error) {
            console.error('Error accediendo a la cámara:', error);
            alert('No se pudo acceder a la cámara. Verifique los permisos.');
        }
    }
    
    function capturePhoto() {
        context.drawImage(video, 0, 0, 300, 225);
        capturedImage = canvas.toDataURL('image/jpeg', 0.8);
        
        // Mostrar imagen capturada brevemente
        video.style.display = 'none';
        canvas.style.display = 'block';
        
        setTimeout(() => {
            video.style.display = 'block';
            canvas.style.display = 'none';
        }, 2000);
        
        markAttendanceBtn.disabled = false;
    }
    
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        
        startCameraBtn.disabled = false;
        capturePhotoBtn.disabled = true;
        stopCameraBtn.disabled = true;
        markAttendanceBtn.disabled = true;
        capturedImage = null;
    }
    
    async function markAttendance() {
        if (!capturedImage) {
            alert('Debe capturar una foto primero');
            return;
        }
        
        if (!currentLocation) {
            alert('Debe permitir el acceso a la ubicación');
            return;
        }
        
        // Mostrar progreso
        processStatus.style.display = 'block';
        markAttendanceBtn.disabled = true;
        
        updateProgress(20, 'Procesando imagen facial...');
        
        try {
            const data = {
                attendance_type: '{{ next_action }}',
                latitude: currentLocation.latitude,
                longitude: currentLocation.longitude,
                location_accuracy: currentLocation.accuracy,
                facial_image: capturedImage,
                device_info: navigator.userAgent,
            };
            
            updateProgress(50, 'Verificando reconocimiento facial...');
            
            const response = await fetch('{% url "attendance:record" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });
            
            updateProgress(80, 'Guardando registro...');
            
            const result = await response.json();
            
            updateProgress(100, 'Completado');
            
            setTimeout(() => {
                processStatus.style.display = 'none';
                showResult(result);
                
                if (result.success) {
                    // Recargar página para mostrar nuevo registro
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    markAttendanceBtn.disabled = false;
                }
            }, 1000);
            
        } catch (error) {
            console.error('Error marcando asistencia:', error);
            processStatus.style.display = 'none';
            markAttendanceBtn.disabled = false;
            alert('Error de conexión. Intente nuevamente.');
        }
    }
    
    function updateProgress(percent, text) {
        progressBar.style.width = percent + '%';
        statusText.textContent = text;
    }
    
    function showResult(result) {
        const modal = new bootstrap.Modal(document.getElementById('resultModal'));
        const content = document.getElementById('result-content');
        
        if (result.success) {
            content.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <h5>${result.message}</h5>
                    <hr>
                    <div class="row">
                        <div class="col-6"><strong>Tipo:</strong> ${result.record.type}</div>
                        <div class="col-6"><strong>Hora:</strong> ${result.record.timestamp}</div>
                        <div class="col-6"><strong>Confianza:</strong> ${(result.record.confidence * 100).toFixed(1)}%</div>
                        <div class="col-6"><strong>Ubicación:</strong> ${result.record.location_valid ? 'Válida' : 'Fuera del área'}</div>
                    </div>
                </div>
            `;
        } else {
            content.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <h5>Error en la marcación</h5>
                    <p>${result.error}</p>
                </div>
            `;
        }
        
        modal.show();
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
