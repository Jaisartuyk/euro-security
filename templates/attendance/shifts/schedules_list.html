{% extends 'base.html' %}
{% load static %}

<!-- CSRF Token para JavaScript -->
{% csrf_token %}

{% block title %}Horarios de Trabajo{% endblock %}

{% block extra_css %}
<style>
    .schedule-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
        background: white;
    }
    
    .schedule-card:hover {
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .schedule-header {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .schedule-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        margin-right: 1rem;
    }
    
    .schedule-meta {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        color: #6b7280;
        font-size: 0.875rem;
    }
    
    .meta-item i {
        margin-right: 0.5rem;
        color: #9ca3af;
    }
    
    .filter-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .stats-overview {
        background: linear-gradient(135deg, #3b82f6, #1e40af);
        color: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.875rem;
        opacity: 0.9;
    }
    
    .action-buttons .btn {
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #6b7280;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: #d1d5db;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'attendance:shift_management_dashboard' %}">
                    <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Horarios de Trabajo</li>
        </ol>
    </nav>

    <!-- Header con estadísticas -->
    <div class="stats-overview">
        <div class="row">
            <div class="col-md-8">
                <h1 class="mb-2">
                    {% if show_assignment %}
                    <i class="fas fa-user-clock me-2"></i>Centro de Asignación de Empleados
                    {% else %}
                    <i class="fas fa-calendar-alt me-2"></i>Horarios de Trabajo
                    {% endif %}
                </h1>
                <p class="mb-0">
                    {% if show_assignment %}
                    Selecciona un horario y haz clic en "Asignar Empleados" para gestionar las asignaciones
                    {% else %}
                    Gestiona y supervisa todos los horarios de trabajo de tu organización
                    {% endif %}
                </p>
            </div>
            <div class="col-md-4">
                <div class="row">
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="stat-number">{{ schedules.count }}</div>
                            <div class="stat-label">Horarios Totales</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="stat-number">{{ active_schedules_count }}</div>
                            <div class="stat-label">Activos</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros y Acciones -->
    <div class="filter-section">
        <div class="row align-items-center">
            <div class="col-md-8">
                <form method="get" class="d-flex gap-3 align-items-end">
                    <div class="flex-grow-1">
                        <label for="search" class="form-label">Buscar Horarios</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               value="{{ current_search }}" placeholder="Nombre, descripción...">
                    </div>
                    <div>
                        <label for="schedule_type" class="form-label">Tipo</label>
                        <select class="form-select" id="schedule_type" name="schedule_type">
                            <option value="">Todos los tipos</option>
                            <option value="INDIVIDUAL" {% if current_schedule_type == 'INDIVIDUAL' %}selected{% endif %}>Individual</option>
                            <option value="DEPARTMENT" {% if current_schedule_type == 'DEPARTMENT' %}selected{% endif %}>Departamento</option>
                            <option value="POSITION" {% if current_schedule_type == 'POSITION' %}selected{% endif %}>Por Puesto</option>
                            <option value="GLOBAL" {% if current_schedule_type == 'GLOBAL' %}selected{% endif %}>Global</option>
                        </select>
                    </div>
                    <div>
                        <label for="status" class="form-label">Estado</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">Todos</option>
                            <option value="active" {% if current_status == 'active' %}selected{% endif %}>Activos</option>
                            <option value="inactive" {% if current_status == 'inactive' %}selected{% endif %}>Inactivos</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                    </button>
                </form>
            </div>
            <div class="col-md-4 text-end">
                <a href="{% url 'attendance:create_work_schedule' %}" class="btn btn-success">
                    <i class="fas fa-plus me-2"></i>Nuevo Horario
                </a>
            </div>
        </div>
    </div>

    <!-- Lista de Horarios -->
    {% if schedules %}
    <div class="row">
        {% for schedule in schedules %}
        <div class="col-lg-6 col-xl-4">
            <div class="schedule-card" data-schedule-colors="{{ schedule.shift_template.color_primary }},{{ schedule.shift_template.color_secondary }}">
                <div class="schedule-header">
                    <div class="schedule-icon" data-primary-color="{{ schedule.shift_template.color_primary }}">
                        <i class="{{ schedule.shift_template.icon_name }}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="mb-1">{{ schedule.name }}</h5>
                        <p class="text-muted mb-0">{{ schedule.shift_template.name }}</p>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="{% url 'attendance:schedule_detail' schedule.id %}">
                                    <i class="fas fa-eye me-2"></i>Ver Detalles
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'attendance:edit_schedule' schedule.id %}">
                                    <i class="fas fa-edit me-2"></i>Editar
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" 
                                   onclick="event.preventDefault(); openAssignModal({{ schedule.id }}, '{{ schedule.name|escapejs }}');">
                                    <i class="fas fa-users me-2"></i>Asignar Empleados
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item text-danger" href="#" 
                                   onclick="event.preventDefault(); confirmDelete({{ schedule.id }}, '{{ schedule.name|escapejs }}');">
                                    <i class="fas fa-trash me-2"></i>Eliminar
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                
                {% if schedule.description %}
                <p class="text-muted mb-3">{{ schedule.description|truncatechars:100 }}</p>
                {% endif %}
                
                <div class="schedule-meta">
                    <div class="meta-item">
                        <i class="fas fa-tag"></i>
                        <span class="badge bg-primary">{{ schedule.get_schedule_type_display }}</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-calendar-start"></i>
                        {{ schedule.start_date|date:"d/m/Y" }}
                    </div>
                    {% if schedule.end_date %}
                    <div class="meta-item">
                        <i class="fas fa-calendar-times"></i>
                        {{ schedule.end_date|date:"d/m/Y" }}
                    </div>
                    {% endif %}
                    <div class="meta-item">
                        <i class="fas fa-clock"></i>
                        {{ schedule.shift_template.hours_per_shift }}h por turno
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        {% if schedule.is_active %}
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle me-1"></i>Activo
                        </span>
                        {% else %}
                        <span class="badge bg-secondary">
                            <i class="fas fa-pause-circle me-1"></i>Inactivo
                        </span>
                        {% endif %}
                        
                        <span class="badge bg-info ms-1">
                            {{ schedule.shifts.count }} turnos
                        </span>
                    </div>
                    
                    <div class="action-buttons">
                        <a href="{% url 'attendance:schedule_detail' schedule.id %}" 
                           class="btn btn-sm btn-outline-primary" 
                           title="Ver Detalles">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="{% url 'attendance:edit_schedule' schedule.id %}" 
                           class="btn btn-sm btn-outline-warning" 
                           title="Editar">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button class="btn btn-sm btn-outline-success" 
                                title="Asignar Empleados"
                                onclick="openAssignModal({{ schedule.id }}, '{{ schedule.name|escapejs }}')">
                            <i class="fas fa-users"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" 
                                title="Eliminar"
                                onclick="confirmDelete({{ schedule.id }}, '{{ schedule.name|escapejs }}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Paginación -->
    {% if is_paginated %}
    <nav aria-label="Paginación de horarios">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?{% if current_search %}search={{ current_search }}&{% endif %}{% if current_schedule_type %}schedule_type={{ current_schedule_type }}&{% endif %}{% if current_status %}status={{ current_status }}&{% endif %}page={{ page_obj.previous_page_number }}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active">
                <span class="page-link bg-primary border-primary">{{ num }}</span>
            </li>
            {% else %}
            <li class="page-item">
                <a class="page-link" href="?{% if current_search %}search={{ current_search }}&{% endif %}{% if current_schedule_type %}schedule_type={{ current_schedule_type }}&{% endif %}{% if current_status %}status={{ current_status }}&{% endif %}page={{ num }}">{{ num }}</a>
            </li>
            {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?{% if current_search %}search={{ current_search }}&{% endif %}{% if current_schedule_type %}schedule_type={{ current_schedule_type }}&{% endif %}{% if current_status %}status={{ current_status }}&{% endif %}page={{ page_obj.next_page_number }}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <!-- Estado vacío -->
    <div class="empty-state">
        <i class="fas fa-calendar-times"></i>
        <h3>No hay horarios creados</h3>
        <p>Comienza creando tu primer horario de trabajo</p>
        <a href="{% url 'attendance:create_work_schedule' %}" class="btn btn-primary btn-lg">
            <i class="fas fa-plus me-2"></i>Crear Primer Horario
        </a>
    </div>
    {% endif %}
</div>

<!-- Modal de Asignación Rápida -->
<div class="modal fade" id="assignModal" tabindex="-1" aria-labelledby="assignModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignModalLabel">
                    <i class="fas fa-users me-2"></i>Asignar Empleados al Horario
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Información del horario -->
                <div class="alert alert-info mb-4">
                    <h6 class="mb-2">Horario: <span id="modalScheduleName"></span></h6>
                    <p class="mb-0">Selecciona los empleados que deseas asignar a este horario</p>
                </div>
                
                <!-- Filtros de búsqueda -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="employeeSearch" 
                               placeholder="Buscar empleados..." onkeyup="searchEmployees()">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="departmentFilter" onchange="filterEmployees()">
                            <option value="">Todos los departamentos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-outline-primary" onclick="loadEmployees()">
                            <i class="fas fa-refresh me-1"></i>Actualizar
                        </button>
                    </div>
                </div>
                
                <!-- Lista de empleados -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">Empleados Disponibles</h6>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="selectAllEmployees()">
                                    <i class="fas fa-check-square me-1"></i>Seleccionar Todos
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                                    <i class="fas fa-square me-1"></i>Limpiar
                                </button>
                            </div>
                        </div>
                        
                        <div id="employeesList" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2 text-muted">Cargando empleados...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Configuración de asignación -->
                <div class="row">
                    <div class="col-md-6">
                        <label for="assignStartDate" class="form-label">Fecha de Inicio *</label>
                        <input type="date" class="form-control" id="assignStartDate" required>
                    </div>
                    <div class="col-md-6">
                        <label for="assignEndDate" class="form-label">Fecha de Fin (Opcional)</label>
                        <input type="date" class="form-control" id="assignEndDate">
                    </div>
                </div>
                
                <div class="mt-3">
                    <label for="assignNotes" class="form-label">Notas (Opcional)</label>
                    <textarea class="form-control" id="assignNotes" rows="2" 
                             placeholder="Notas adicionales sobre la asignación..."></textarea>
                </div>
                
                <!-- Resumen de selección -->
                <div id="selectionSummary" class="alert alert-success mt-3" style="display: none;">
                    <strong>Empleados seleccionados: <span id="selectedCount">0</span></strong>
                    <div id="selectedEmployees" class="mt-2"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="assignSelectedEmployees()" id="assignBtn" disabled>
                    <i class="fas fa-user-plus me-1"></i>Asignar Empleados
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Aplicar colores dinámicos
        applyDynamicColors();
    });
    
    function applyDynamicColors() {
        // Aplicar colores a iconos de horarios
        document.querySelectorAll('[data-primary-color]').forEach(element => {
            const color = element.getAttribute('data-primary-color');
            element.style.backgroundColor = color;
        });
        
        // Aplicar colores a cards de horarios
        document.querySelectorAll('[data-schedule-colors]').forEach(element => {
            const colors = element.getAttribute('data-schedule-colors').split(',');
            const primary = colors[0];
            element.style.borderLeftColor = primary;
            element.style.borderLeftWidth = '4px';
        });
    }
    
    // Variables globales para el modal
    let currentScheduleId = null;
    let allEmployees = [];
    let selectedEmployees = [];
    
    // Abrir modal de asignación
    function openAssignModal(scheduleId, scheduleName) {
        currentScheduleId = scheduleId;
        document.getElementById('modalScheduleName').textContent = scheduleName;
        
        // Establecer fecha de inicio por defecto (hoy)
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('assignStartDate').value = today;
        
        // Limpiar selección anterior
        selectedEmployees = [];
        updateSelectionSummary();
        
        // Cargar empleados
        loadEmployees();
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('assignModal'));
        modal.show();
    }
    
    // Cargar empleados disponibles
    function loadEmployees() {
        const employeesList = document.getElementById('employeesList');
        employeesList.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2 text-muted">Cargando empleados...</p>
            </div>
        `;
        
        fetch('/asistencia/api/empleados-disponibles/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allEmployees = data.employees;
                    renderEmployees(allEmployees);
                } else {
                    employeesList.innerHTML = `
                        <div class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p>Error cargando empleados: ${data.error}</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="loadEmployees()">
                                <i class="fas fa-refresh me-1"></i>Reintentar
                            </button>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                employeesList.innerHTML = `
                    <div class="text-center py-4 text-danger">
                        <i class="fas fa-wifi fa-2x mb-2"></i>
                        <p>Error de conexión</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="loadEmployees()">
                            <i class="fas fa-refresh me-1"></i>Reintentar
                        </button>
                    </div>
                `;
            });
    }
    
    // Renderizar lista de empleados
    function renderEmployees(employees) {
        const employeesList = document.getElementById('employeesList');
        
        if (employees.length === 0) {
            employeesList.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <p>No se encontraron empleados</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        employees.forEach(employee => {
            const isSelected = selectedEmployees.includes(employee.id);
            html += `
                <div class="form-check border-bottom py-2">
                    <input class="form-check-input" type="checkbox" value="${employee.id}" 
                           id="emp_${employee.id}" ${isSelected ? 'checked' : ''}
                           onchange="toggleEmployee(${employee.id})">
                    <label class="form-check-label d-flex align-items-center" for="emp_${employee.id}">
                        <div class="me-3">
                            ${employee.photo_url ? 
                                `<img src="${employee.photo_url}" class="rounded-circle" width="40" height="40">` :
                                `<div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; color: white;">
                                    <i class="fas fa-user"></i>
                                </div>`
                            }
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold">${employee.full_name}</div>
                            <small class="text-muted">${employee.employee_id} - ${employee.department}</small>
                            <br><small class="text-muted">${employee.position}</small>
                            ${employee.current_assignments > 0 ? 
                                `<span class="badge bg-warning text-dark ms-2">${employee.current_assignments} asignaciones</span>` : 
                                ''
                            }
                        </div>
                    </label>
                </div>
            `;
        });
        
        employeesList.innerHTML = html;
    }
    
    // Toggle selección de empleado
    function toggleEmployee(employeeId) {
        const index = selectedEmployees.indexOf(employeeId);
        if (index > -1) {
            selectedEmployees.splice(index, 1);
        } else {
            selectedEmployees.push(employeeId);
        }
        updateSelectionSummary();
    }
    
    // Seleccionar todos los empleados
    function selectAllEmployees() {
        const checkboxes = document.querySelectorAll('#employeesList input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
            const employeeId = parseInt(checkbox.value);
            if (!selectedEmployees.includes(employeeId)) {
                selectedEmployees.push(employeeId);
            }
        });
        updateSelectionSummary();
    }
    
    // Limpiar selección
    function clearSelection() {
        const checkboxes = document.querySelectorAll('#employeesList input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        selectedEmployees = [];
        updateSelectionSummary();
    }
    
    // Actualizar resumen de selección
    function updateSelectionSummary() {
        const summary = document.getElementById('selectionSummary');
        const countSpan = document.getElementById('selectedCount');
        const employeesDiv = document.getElementById('selectedEmployees');
        const assignBtn = document.getElementById('assignBtn');
        
        countSpan.textContent = selectedEmployees.length;
        
        if (selectedEmployees.length > 0) {
            summary.style.display = 'block';
            assignBtn.disabled = false;
            
            // Mostrar nombres de empleados seleccionados
            const selectedNames = selectedEmployees.map(id => {
                const employee = allEmployees.find(emp => emp.id === id);
                return employee ? employee.full_name : 'Desconocido';
            });
            
            employeesDiv.innerHTML = selectedNames.slice(0, 5).join(', ') + 
                (selectedNames.length > 5 ? ` y ${selectedNames.length - 5} más...` : '');
        } else {
            summary.style.display = 'none';
            assignBtn.disabled = true;
        }
    }
    
    // Buscar empleados
    function searchEmployees() {
        const search = document.getElementById('employeeSearch').value.toLowerCase();
        const filtered = allEmployees.filter(emp => 
            emp.full_name.toLowerCase().includes(search) ||
            emp.employee_id.toLowerCase().includes(search) ||
            emp.department.toLowerCase().includes(search)
        );
        renderEmployees(filtered);
    }
    
    // Filtrar por departamento
    function filterEmployees() {
        const department = document.getElementById('departmentFilter').value;
        const filtered = department ? 
            allEmployees.filter(emp => emp.department === department) : 
            allEmployees;
        renderEmployees(filtered);
    }
    
    // Asignar empleados seleccionados
    function assignSelectedEmployees() {
        if (selectedEmployees.length === 0) {
            alert('Por favor selecciona al menos un empleado');
            return;
        }
        
        // Validar que los elementos existen
        const startDateEl = document.getElementById('assignStartDate');
        const endDateEl = document.getElementById('assignEndDate');
        const notesEl = document.getElementById('assignNotes');
        
        if (!startDateEl || !endDateEl || !notesEl) {
            console.error('Error: No se encontraron los elementos del formulario');
            alert('Error: El formulario no está disponible. Por favor recarga la página.');
            return;
        }
        
        const startDate = startDateEl.value;
        if (!startDate) {
            alert('Por favor selecciona una fecha de inicio');
            return;
        }
        
        const endDate = endDateEl.value;
        const notes = notesEl.value;
        
        // Deshabilitar botón y mostrar loading
        const assignBtn = document.getElementById('assignBtn');
        const originalText = assignBtn.innerHTML;
        assignBtn.disabled = true;
        assignBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Asignando...';
        
        // Enviar asignación
        fetch('/asistencia/api/asignacion-masiva/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                employee_ids: selectedEmployees,
                shift_id: currentScheduleId, // Nota: Esto debería ser shift_id, no schedule_id
                start_date: startDate,
                end_date: endDate,
                notes: notes
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`¡Éxito! ${data.assignments_created} empleados asignados correctamente.`);
                
                if (data.errors && data.errors.length > 0) {
                    alert('Algunos errores:\n' + data.errors.join('\n'));
                }
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('assignModal'));
                modal.hide();
                
                // Recargar página para mostrar cambios
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexión. Por favor intenta de nuevo.');
        })
        .finally(() => {
            // Restaurar botón
            assignBtn.disabled = false;
            assignBtn.innerHTML = originalText;
        });
    }
    
    // Función para confirmar eliminación de horario
    function confirmDelete(scheduleId, scheduleName) {
        if (confirm(`¿Estás seguro de que deseas eliminar el horario "${scheduleName}"?\n\nEsta acción no se puede deshacer.`)) {
            // Deshabilitar todos los botones de eliminación temporalmente
            document.querySelectorAll('.btn-outline-danger').forEach(btn => {
                btn.disabled = true;
            });
            
            // Enviar petición de eliminación
            fetch(`/asistencia/turnos/horarios/${scheduleId}/eliminar/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ Horario eliminado correctamente.');
                    // Recargar la página
                    window.location.reload();
                } else {
                    alert('❌ Error al eliminar: ' + (data.error || 'Error desconocido'));
                    // Rehabilitar botones
                    document.querySelectorAll('.btn-outline-danger').forEach(btn => {
                        btn.disabled = false;
                    });
                }
            })
            .catch(error => {
                alert('❌ Error de conexión: ' + error.message);
                // Rehabilitar botones
                document.querySelectorAll('.btn-outline-danger').forEach(btn => {
                    btn.disabled = false;
                });
            });
        }
    }
</script>
{% endblock %}
